<launch>

    <!-- ROBOT MAPPING VERSION: use this with ROS bag demo_mapping.bag -->
    <!-- WARNING : Database is automatically deleted on each startup -->
    <!--           See "delete_db_on_start" option below... -->

    <!-- Choose visualization -->
    <arg name="rviz" default="false" />
    <arg name="rtabmapviz" default="true" />
    <arg name="rgb_topic" default="/camera1/cropped_rgb"/>
    <arg name="depth_topic" default="/camera1/cropped_depth"/>
    <arg name="camera_info_topic" default="/camera1/cropped_camera_info"/>
    <arg name="rgb2_topic" default="/camera2/cropped_rgb"/>
    <arg name="depth2_topic" default="/camera2/cropped_depth"/>
    <arg name="camera2_info_topic" default="/camera2/cropped_camera_info"/>
    <arg name="odom_topic" default="/odometry/gps"/>
    <arg name="scan_topic" default="/scan"/>
    <arg name="cloud_topic" default="/os_cloud_node/points_filtered"/>

    <param name="use_sim_time" type="bool" value="True" />

    <!-- Localization-only mode -->
    <arg name="localization" default="true" />
    <arg if="$(arg localization)" name="rtabmap_args" default="" />
    <arg unless="$(arg localization)" name="rtabmap_args" default="--delete_db_on_start" />

    <!-- ODOMETRY MAIN ARGUMENTS: 
        -"strategy"        : Strategy: 0=Frame-to-Map 1=Frame-to-Frame
        -"feature"         : Feature type: 0=SURF 1=SIFT 2=ORB 3=FAST/FREAK 4=FAST/BRIEF 5=GFTT/FREAK 6=GFTT/BRIEF 7=BRISK
        -"nn"              : Nearest neighbor strategy : 0=Linear, 1=FLANN_KDTREE, 2=FLANN_LSH, 3=BRUTEFORCE 
                             Set to 1 for float descriptor like SIFT/SURF                  
                             Set to 3 for binary descriptor like ORB/FREAK/BRIEF/BRISK  
        -"max_depth"       : Maximum features depth (m)  
        -"min_inliers"     : Minimum visual correspondences to accept a transformation (m)  
        -"inlier_distance" : RANSAC maximum inliers distance (m)  
        -"local_map"       : Local map size: number of unique features to keep track 
        -"odom_info_data"  : Fill odometry info messages with inliers/outliers data.
    -->
   <arg name="strategy"        default="0" />
   <arg name="feature"         default="6" />
   <arg name="nn"              default="3" />
   <arg name="max_depth"       default="4.0" />
   <arg name="min_inliers"     default="20" />
   <arg name="inlier_distance" default="0.02" />
   <arg name="local_map"       default="1000" />
   <arg name="odom_info_data"  default="true" />
   <arg name="wait_for_transform"  default="true" />

    <!-- sync rgb/depth images per camera -->
    <group ns="zedA">
        <node pkg="nodelet" type="nodelet" name="nodelet_manager1" args="manager"/>
        <node pkg="nodelet" type="nodelet" name="rgbd_sync1" args="load rtabmap_ros/rgbd_sync nodelet_manager1">
            <remap from="rgb/image"       to="$(arg rgb_topic)"/>
            <remap from="depth/image"     to="$(arg depth_topic)"/>
            <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>
            <param name="approx"            value="true"/>
        </node>
    </group>
    <group ns="zedB">
        <node pkg="nodelet" type="nodelet" name="nodelet_manager2" args="manager"/>
        <node pkg="nodelet" type="nodelet" name="rgbd_sync2" args="load rtabmap_ros/rgbd_sync nodelet_manager2">
            <remap from="rgb/image"       to="$(arg rgb2_topic)"/>
            <remap from="depth/image"     to="$(arg depth2_topic)"/>
            <remap from="rgb/camera_info" to="$(arg camera2_info_topic)"/>
            <param name="approx"            value="true"/>
        </node>
    </group>

    <group ns="rtabmap">

        

        <node pkg="rtabmap_ros" type="rgbd_odometry" name="rgbd_odometry" output="screen">
            <remap from="rgbd_image0"       to="/zedA/rgbd_image"/>
            <remap from="rgbd_image1"       to="/zedB/rgbd_image"/>
            
            <param name="subscribe_rgbd"           type="bool"   value="true"/>
            <param name="frame_id"                 type="string" value="base_link"/>
            <param name="rgbd_cameras"             type="int"    value="2"/>
            <param name="wait_for_transform"       type="bool"   value="$(arg wait_for_transform)"/>
            <param name="Odom/Strategy"            type="string" value="$(arg strategy)"/> 
            <param name="OdomF2M/BundleAdjustment" type="string" value="0"/> <!-- should be 0 for multi-cameras -->
            <param name="Vis/EstimationType"       type="string" value="0"/> <!-- should be 0 for multi-cameras -->
            <param name="Vis/FeatureType"          type="string" value="$(arg feature)"/> 
            <param name="Vis/CorGuessWinSize"      type="string" value="0"/> 
            <param name="Vis/CorNNType"            type="string" value="$(arg nn)"/>
            <param name="Vis/MaxDepth"             type="string" value="$(arg max_depth)"/>  
            <param name="Vis/MinInliers"           type="string" value="$(arg min_inliers)"/> 
            <param name="Vis/InlierDistance"       type="string" value="$(arg inlier_distance)"/>       
            <param name="OdomF2M/MaxSize"          type="string" value="$(arg local_map)"/> 
            <param name="Odom/FillInfoData"        type="string" value="$(arg odom_info_data)"/>  

            <param name="approx_sync" type="boolean" value="true"/>
            <!-- <param name="approx_rgbd_sync"            value="true"/>          false=exact synchronization -->
            <param name="queue_size"  value="30"/> 
        </node>

        <!-- SLAM (robot side) -->
        <!-- args: "delete_db_on_start" and "udebug" -->
        <node name="rtabmap" pkg="rtabmap_ros" type="rtabmap" output="screen" args="$(arg rtabmap_args)">
            <remap from="rgbd_image0"       to="/zedA/rgbd_image"/>
            <remap from="rgbd_image1"       to="/zedB/rgbd_image"/>
            
            <param name="frame_id"                            type="string" value="base_link" />
            <param name="wait_for_transform"                  type="bool" value="$(arg wait_for_transform)" />
            <param name="subscribe_depth"                     type="bool"   value="false"/>
            <param name="subscribe_rgbd"                      type="bool"   value="true"/>
            <param name="subscribe_scan"                      type="bool" value="true" />
            <param name="subscribe_scan_cloud"                type="bool" value="false" />
            <param name="map_negative_poses_ignored"          type="bool"   value="false"/>        <!-- refresh grid map even if we are not moving-->
	        <param name="map_negative_scan_empty_ray_tracing" type="bool" value="false"/> <!-- don't fill empty space between the generated scans-->

            <!-- As /az3/base_controller/odom topic doesn't provide covariances, we use TF to get odom and we fix the covariance -->
            <param name="odom_frame_id"            type="string" value="odom" />
            <param name="odom_tf_linear_variance"  type="double" value="0.001" />
            <param name="odom_tf_angular_variance" type="double" value="0.001" />
            
            <!-- <remap from="odom"            to="$(arg odom_topic)"/> -->
            <remap from="scan"            to="$(arg scan_topic)"/>
            <remap from="scan_cloud"      to="$(arg cloud_topic)"/>

           

            <!-- <param name="rgb/image_transport"   type="string" value="compressed"/>
	  <param name="depth/image_transport" type="string" value="compressedDepth"/> -->

            <!-- RTAB-Map's parameters: do "rosrun rtabmap rtabmap (double-dash)params" to see the list of available parameters. -->
            <param name="RGBD/NeighborLinkRefining"         type="string" value="true" />
            <!-- Do odometry correction with consecutive laser scans -->
            <param name="RGBD/ProximityBySpace"             type="string" value="true" />
            <!-- Local loop closure detection (using estimated position) with locations in WM -->
            <param name="RGBD/ProximityByTime"              type="string" value="false" />
            <!-- Local loop closure detection with locations in STM -->
            <param name="RGBD/ProximityPathMaxNeighbors"    type="string" value="10" />
            <!-- Do also proximity detection by space by merging close scans together. -->
            <param name="Reg/Strategy"                      type="string" value="1" /> <!-- 0=Visual, 1=ICP, 2=Visual+ICP -->
            <param name="Vis/MinInliers"                    type="string" value="10" /> <!-- 3D visual words correspondence distance -->
            <param name="Vis/InlierDistance"                type="string" value="$(arg inlier_distance)"/>
            <param name="Vis/EstimationType"                type="string" value="0"/> <!-- should be 0 for multi-cameras -->
            <param name="RGBD/OptimizeFromGraphEnd"         type="string" value="false" />
            <!-- Optimize graph from initial node so /map -> /odom transform will be generated -->
            <param name="RGBD/OptimizeMaxError"             type="string" value="4" />
            <!-- Reject any loop closure causing large errors (>3x link's covariance) in the map -->
            <param name="Reg/Force3DoF"                     type="string" value="true" /> <!-- 2D SLAM -->
            <param name="Grid/FromDepth"                    type="string" value="false" />
            <!-- Create 2D occupancy grid from laser scan -->
            <param name="Mem/STMSize"                       type="string" value="30" />
            <!-- increased to 30 to avoid adding too many loop closures on just seen locations -->
            <param name="RGBD/LocalRadius"                  type="string" value="5" /> <!-- limit length of proximity detections -->
            <param name="Icp/CorrespondenceRatio"           type="string" value="0.2" />
            <!-- minimum scan overlap to accept loop closure -->
            <param name="Icp/PM"                            type="string" value="false" />
            <param name="Icp/PointToPlane"                  type="string" value="false" />
            <param name="Icp/MaxCorrespondenceDistance"     type="string" value="0.15" />
            <param name="Icp/VoxelSize"                     type="string" value="0.05" />

            <!-- localization mode -->
            <param if="$(arg localization)" name="Mem/IncrementalMemory" type="string" value="false" />
            <param unless="$(arg localization)" name="Mem/IncrementalMemory" type="string" value="true" />
            <param name="Mem/InitWMWithAllNodes"    type="string" value="$(arg localization)" />
        </node>

        <!-- Visualisation RTAB-Map -->
        <node if="$(arg rtabmapviz)" pkg="rtabmap_ros" type="rtabmapviz" name="rtabmapviz"
            args="-d $(find rtabmap_ros)/launch/config/rgbd_gui.ini" output="screen">
            <param name="subscribe_depth"       type="bool" value="false" />
            <!-- <param name="subscribe_scan_cloud" type="bool" value="true" /> -->
            <param name="subscribe_rgbd"        type="bool"   value="true"/>
            <param name="subscribe_odom_info"   type="bool"   value="$(arg odom_info_data)"/>
            <param name="rgbd_cameras"          type="int"    value="2"/>>
            <param name="frame_id"              type="string" value="base_link" />
            <param name="wait_for_transform"    type="bool" value="$(arg wait_for_transform)" />

            <remap from="rgbd_image0"       to="/zedA/rgbd_image"/>
            <remap from="rgbd_image1"       to="/zedB/rgbd_image"/>
            <remap from="odom" to="$(arg odom_topic)" />

        </node>
    </group>

    <!-- Visualisation RVIZ -->
    <node if="$(arg rviz)" pkg="rviz" type="rviz" name="rviz"
        args="-d $(find rtabmap_ros)/launch/config/demo_robot_mapping.rviz" output="screen" />
    <node pkg="nodelet" type="nodelet" name="points_xyzrgb" args="standalone rtabmap_ros/point_cloud_xyzrgb">
        <remap from="rgb/image"         to="$(arg rgb_topic)" />
        <remap from="depth/image"       to="$(arg depth_topic)" />
        <remap from="rgb/camera_info"   to="$(arg camera_info_topic)" />
        <remap from="cloud"             to="voxel_cloud" />

        <!-- <param name="rgb/image_transport" type="string" value="compressed" />
        <param name="depth/image_transport" type="string" value="compressedDepth" /> -->

        <param name="queue_size"    type="int" value="10" />
        <param name="voxel_size"    type="double" value="0.0" />
        <param name="decimation"    type="double" value="4" />
        <param name="max_depth"     type="double" value="15.0" />
    </node>

</launch>